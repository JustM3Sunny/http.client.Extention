<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTTP Client</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles to complement Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #d1d5db; /* text-gray-300 */
        }

        /* Custom focus rings for better accessibility */
        select:focus, input:focus, textarea:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            --tw-ring-color: #4f46e5; /* ring-indigo-500 */
            box-shadow: 0 0 0 2px var(--tw-ring-color);
        }

        /* Custom scrollbar for a more integrated look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }

        /* Style for the active request tab */
        .request-tab.active {
            color: #4f46e5; /* text-indigo-500 */
            border-color: #4f46e5; /* border-indigo-500 */
        }

        /* Style for the active response tab */
        .response-tab.active {
            color: #4f46e5; /* text-indigo-500 */
            border-color: #4f46e5; /* border-indigo-500 */
        }

        /* Hide content that is not active */
        .tab-content:not(.active), .response-tab-content:not(.active) {
            display: none;
        }
    </style>
</head>
<body class="antialiased">

    <div class="mx-auto max-w-7xl p-4 sm:p-6 lg:p-8">
        <!-- Header with Tabs -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-white">HTTP Client</h1>
            <div class="flex space-x-2">
                <button id="history-btn" class="flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-gray-300 hover:text-white hover:bg-gray-700 rounded-md transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022l-.074.997zm2.004.45a7.003 7.003 0 0 0-.985-.299l-.219-.976c.383.086.76.2 1.126.342l.078-.025zM1 0l1.255.714a8 8 0 0 1 4.741-1.08l.07 1.001A7 7 0 0 0 1.98 1.4L1 0zm.837 1.366a8 8 0 0 1-.07 1.03 7 7 0 0 0-.862 3.37l.002.01L0 5.5l.004.5a8 8 0 0 1 2.54-3.668l-.707-.708z"/>
                        <path d="M14 1.5a.5.5 0 0 1 0-1v1zm-1 0v1a.5.5 0 0 1 0-1zm-2 0v-1a.5.5 0 0 1 .5.5h-1a1.5 1.5 0 0 0-1.5 1.5v1a1.5 1.5 0 0 0 1.5 1.5h1a1.5 1.5 0 0 0 1.5-1.5v-1a.5.5 0 0 1 .5-.5z"/>
                        <path d="M3.5 6h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1 0-1z"/>
                        <path d="M3 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5z"/>
                    </svg>
                    History
                </button>
                <button id="env-btn" class="flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-gray-300 hover:text-white hover:bg-gray-700 rounded-md transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 16a6 6 0 0 0 6-6c0-1.655-1.122-2.904-2.432-4.362C10.254 4.176 8.75 2.503 8 0c-.75 2.503-2.254 4.176-3.568 5.638C3.122 7.096 2 8.345 2 10a6 6 0 0 0 6 6zM6 9.5a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0z"/>
                    </svg>
                    Environment
                </button>
            </div>
        </div>

        <!-- Request Container -->
        <div class="bg-gray-800/50 backdrop-blur-sm ring-1 ring-white/10 rounded-xl p-6 mb-8">
            <!-- URL and Send Button Container -->
            <div class="flex flex-col sm:flex-row gap-2 mb-6">
                <div class="relative flex-shrink-0 w-32">
                    <select id="method" class="w-full bg-gray-900 border border-gray-700 rounded-md pl-3 pr-8 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 appearance-none">
                        <option>GET</option>
                        <option>POST</option>
                        <option>PUT</option>
                        <option>DELETE</option>
                        <option>PATCH</option>
                        <option>HEAD</option>
                        <option>OPTIONS</option>
                        <option>TRACE</option>
                        <option>CONNECT</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                </div>
                
                <div class="relative flex-grow">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="text-gray-500" viewBox="0 0 16 16">
                            <path d="M4.5 5a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1zM3 4.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0z"/>
                            <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4zm1 0v8a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1H2a1 1 0 0 0-1 1zm6.5 0a.5.5 0 0 1 .5.5v3.5h3a.5.5 0 0 1 0 1h-3.5a.5.5 0 0 1-.5-.5v-4a.5.5 0 0 1 .5-.5z"/>
                        </svg>
                    </div>
                    <input type="text" id="url" placeholder="https://api.example.com/data" class="w-full pl-10 pr-3 py-2 bg-gray-900 border border-gray-700 rounded-md text-white placeholder-gray-500 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                    <div id="url-history" class="absolute z-10 w-full mt-1 bg-gray-800 border border-gray-700 rounded-md shadow-lg hidden">
                        <!-- URL history items will be added here dynamically -->
                    </div>
                </div>
                <input type="text" id="url" placeholder="https://api.example.com/data" class="flex-grow bg-gray-900 border border-gray-700 rounded-md px-4 py-2 text-white placeholder-gray-500 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                <button id="sendRequest" class="flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-2 rounded-md transition duration-150 disabled:opacity-50 disabled:cursor-wait">
                    <svg id="send-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send" viewBox="0 0 16 16">
                      <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/>
                    </svg>
                    <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span id="send-text">Send</span>
                </button>
            </div>

            <!-- Request Tabs -->
            <div class="border-b border-gray-700">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <a href="#" class="request-tab active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-indigo-400 hover:border-indigo-400" data-tab="params">Params</a>
                    <a href="#" class="request-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-indigo-400 hover:border-indigo-400" data-tab="headers">Headers</a>
                    <a href="#" class="request-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-indigo-400 hover:border-indigo-400" data-tab="body">Body</a>
                </nav>
            </div>

            <!-- Request Tab Content -->
            <div class="mt-6">
                <div id="params-tab" class="tab-content active">
                    <p class="text-sm text-gray-400">Query parameters can be added directly to the URL, for example: <code class="bg-gray-900 px-1 py-0.5 rounded">?id=123</code></p>
                </div>
                <div id="headers-tab" class="tab-content">
                    <div id="headers-container" class="space-y-3">
                        <!-- Header rows will be dynamically added here -->
                    </div>
                    <button id="add-header" class="mt-4 flex items-center gap-2 text-sm font-medium text-indigo-400 hover:text-indigo-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">
                          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                          <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                        </svg>
                        Add Header
                    </button>
                </div>
                <div id="body-tab" class="tab-content space-y-4">
                    <div class="flex items-center justify-between">
                        <label class="text-sm font-medium text-gray-300">Content-Type</label>
                        <div class="relative w-48">
                            <select id="content-type" class="w-full bg-gray-900 border border-gray-700 rounded-md pl-3 pr-8 py-1.5 text-sm text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 appearance-none">
                                <option value="application/json">JSON (application/json)</option>
                                <option value="application/x-www-form-urlencoded">Form URL Encoded</option>
                                <option value="text/plain">Plain Text</option>
                                <option value="text/xml">XML</option>
                                <option value="text/html">HTML</option>
                                <option value="application/javascript">JavaScript</option>
                                <option value="application/xml">XML (application/xml)</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="relative">
                        <div id="json-editor" class="h-64 overflow-auto bg-gray-900 border border-gray-700 rounded-md p-3 font-mono text-sm">
                            <div id="requestBody" class="min-h-full outline-none" contenteditable="true" data-placeholder='{&#10;  "key": "value"&#10;}'></div>
                        </div>
                        <div id="form-editor" class="hidden space-y-3">
                            <div class="form-row flex items-center gap-2">
                                <input type="text" placeholder="Key" class="flex-1 bg-gray-900 border border-gray-700 rounded-md px-3 py-1.5 text-white placeholder-gray-500">
                                <span class="text-gray-400">=</span>
                                <input type="text" placeholder="Value" class="flex-1 bg-gray-900 border border-gray-700 rounded-md px-3 py-1.5 text-white placeholder-gray-500">
                                <button class="remove-form-row p-1.5 text-gray-500 hover:text-red-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                    </svg>
                                </button>
                            </div>
                            <button id="add-form-row" class="mt-2 flex items-center gap-1.5 text-sm text-indigo-400 hover:text-indigo-300">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                                </svg>
                                Add Field
                            </button>
                        </div>
                        <div id="text-editor" class="hidden">
                            <textarea id="raw-body" class="w-full h-64 bg-gray-900 border border-gray-700 rounded-md p-3 text-white placeholder-gray-500 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 font-mono text-sm" placeholder="Enter request body text here"></textarea>
                        </div>
                        <div class="mt-2 flex justify-between items-center text-xs text-gray-500">
                            <span id="char-count">0 characters</span>
                            <div class="space-x-2">
                                <button id="format-json" class="text-indigo-400 hover:text-indigo-300 disabled:opacity-50" disabled>Format</button>
                                <button id="minify-json" class="text-indigo-400 hover:text-indigo-300 disabled:opacity-50" disabled>Minify</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Response Container -->
        <div class="response-container">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-white">Response</h2>
                <div id="status" class="text-sm font-medium px-3 py-1 rounded-full"></div>
            </div>
            
            <!-- Response Tabs -->
            <div class="border-b border-gray-700">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <a href="#" class="response-tab active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-indigo-400 hover:border-indigo-400" data-tab="response-body">Body</a>
                    <a href="#" class="response-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-indigo-400 hover:border-indigo-400" data-tab="response-headers">Headers</a>
                </nav>
            </div>

            <!-- Response Content -->
            <div class="mt-6">
                <div id="response-body-tab" class="response-tab-content active relative">
                     <button id="copy-response-btn" class="absolute top-3 right-3 p-1.5 text-gray-400 bg-gray-700 hover:bg-gray-600 rounded-md transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                            <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zM-1 8a.5.5 0 0 1 .5-.5h15a.5.5 0 0 1 0 1h-15A.5.5 0 0 1-1 8z"/>
                        </svg>
                     </button>
                    <pre id="responseBody" class="w-full max-h-[400px] overflow-auto bg-gray-900 rounded-md p-4 text-sm text-gray-300 font-mono ring-1 ring-gray-700">Send a request to see the response here</pre>
                </div>
                <div id="response-headers-tab" class="response-tab-content">
                    <pre id="responseHeaders" class="w-full max-h-[400px] overflow-auto bg-gray-900 rounded-md p-4 text-sm text-gray-300 font-mono ring-1 ring-gray-700"></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Mock vscode api for browser testing if not in a webview
        const vscode = typeof acquireVsCodeApi === 'function' 
            ? acquireVsCodeApi() 
            : { postMessage: function(msg) { console.log('VSCode Message:', msg); } };
            
        // State management
        const state = {
            requestHistory: JSON.parse(localStorage.getItem('requestHistory') || '[]'),
            environments: JSON.parse(localStorage.getItem('environments') || '{}'),
            currentEnvironment: localStorage.getItem('currentEnvironment') || '',
            currentContentType: 'application/json',
            requestBody: {},
            formData: []
        };
        
        // DOM Elements
        const urlInput = document.getElementById('url');
        const methodSelect = document.getElementById('method');
        const sendRequestBtn = document.getElementById('sendRequest');
        const contentTypeSelect = document.getElementById('content-type');
        const jsonEditor = document.getElementById('json-editor');
        const formEditor = document.getElementById('form-editor');
        const textEditor = document.getElementById('text-editor');
        const requestBody = document.getElementById('requestBody');
        const rawBody = document.getElementById('raw-body');
        const charCount = document.getElementById('char-count');
        const formatJsonBtn = document.getElementById('format-json');
        const minifyJsonBtn = document.getElementById('minify-json');
        const addFormRowBtn = document.getElementById('add-form-row');
        const formContainer = document.querySelector('#form-editor .form-rows');
        const headersContainer = document.getElementById('headers-container');
        const historyList = document.getElementById('history-list');
        const urlHistory = document.getElementById('url-history');
        
        // Initialize the UI
        function initUI() {
            // Load request history
            if (typeof renderHistory === 'function') {
                renderHistory();
            }
            
            // Set up content type change handler
            if (contentTypeSelect) {
                contentTypeSelect.addEventListener('change', handleContentTypeChange);
            }
            
            // Set up JSON editor events
            if (requestBody) {
                requestBody.addEventListener('input', updateCharCount);
                requestBody.addEventListener('keydown', handleTabKey);
                requestBody.addEventListener('paste', handlePaste);
            }
            
            // Set up raw body events
            if (rawBody) {
                rawBody.addEventListener('input', updateCharCount);
            }
            
            // Set up format/minify buttons
            if (formatJsonBtn) formatJsonBtn.addEventListener('click', formatJson);
            if (minifyJsonBtn) minifyJsonBtn.addEventListener('click', minifyJson);
            
            // Set up form editor
            if (addFormRowBtn) addFormRowBtn.addEventListener('click', addFormRow);
            
            // Set up URL input with history
            if (urlInput) {
                urlInput.addEventListener('focus', showUrlHistory);
                urlInput.addEventListener('blur', function() {
                    // Delay hiding to allow click events on history items
                    setTimeout(function() {
                        if (urlHistory) urlHistory.classList.add('hidden');
                    }, 200);
                });
            }
            
            // Set initial content type
            handleContentTypeChange();
            
            // Load environment variables if any
            loadEnvironment();
        }
        
        // Handle content type changes
        function handleContentTypeChange() {
            const contentType = contentTypeSelect.value;
            state.currentContentType = contentType;
            
            // Hide all editors
            if (jsonEditor) jsonEditor.classList.add('hidden');
            if (formEditor) formEditor.classList.add('hidden');
            if (textEditor) textEditor.classList.add('hidden');
            
            // Show the appropriate editor
            if (contentType === 'application/x-www-form-urlencoded') {
                if (formEditor) formEditor.classList.remove('hidden');
                if (formContainer && formContainer.children.length === 0) {
                    addFormRow();
                }
            } else if (contentType === 'application/json') {
                if (jsonEditor) jsonEditor.classList.remove('hidden');
            } else {
                if (textEditor) textEditor.classList.remove('hidden');
            }
            
            // Update headers
            updateContentTypeHeader();
        }
        
        // Update Content-Type header
        function updateContentTypeHeader() {
            let headerExists = false;
            const contentType = contentTypeSelect.value;
            let headers = [];
            
            // Get existing headers
            document.querySelectorAll('.header-row').forEach(row => {
                const nameInput = row.querySelector('.header-name');
                const valueInput = row.querySelector('.header-value');
                if (nameInput && valueInput) {
                    if (nameInput.value.toLowerCase() === 'content-type') {
                        valueInput.value = contentType;
                        headerExists = true;
                    }
                    headers.push({ name: nameInput.value, value: valueInput.value });
                }
            });
            
            // Add Content-Type header if it doesn't exist
            if (!headerExists && contentType) {
                addHeader('Content-Type', contentType);
            }
        }
        
        // Add a header row
        function addHeader(name, value) {
            name = name || '';
            value = value || '';
            const headerRow = document.createElement('div');
            headerRow.className = 'header-row flex items-center gap-2';
            headerRow.innerHTML = '
                <input type="text" placeholder="Header" value="' + name + '" class="header-name flex-1 bg-gray-900 border border-gray-700 rounded-md px-3 py-1.5 text-white placeholder-gray-500 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 text-sm">
                <input type="text" placeholder="Value" value="' + value + '" class="header-value flex-1 bg-gray-900 border border-gray-700 rounded-md px-3 py-1.5 text-white placeholder-gray-500 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 text-sm">
                <button class="remove-header p-1.5 text-gray-500 hover:text-red-400 hover:bg-gray-700 rounded-md transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                    </svg>
                </button>';
                
            
            if (headersContainer) {
                headersContainer.appendChild(headerRow);
                
                // Add event listener for remove button
                const removeBtn = headerRow.querySelector('.remove-header');
                if (removeBtn) {
                    removeBtn.addEventListener('click', () => {
                        headerRow.remove();
                    });
                }
            }
            
            return headerRow;
        }
        
        // Add form row
        function addFormRow() {
            const formRow = document.createElement('div');
            formRow.className = 'form-row flex items-center gap-2';
            formRow.innerHTML = '
                <input type="text" placeholder="Key" class="flex-1 bg-gray-900 border border-gray-700 rounded-md px-3 py-1.5 text-white placeholder-gray-500 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 text-sm">
                <span class="text-gray-400">=</span>
                <input type="text" placeholder="Value" class="flex-1 bg-gray-900 border border-gray-700 rounded-md px-3 py-1.5 text-white placeholder-gray-500 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 text-sm">
                <button class="remove-form-row p-1.5 text-gray-500 hover:text-red-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                    </svg>
                </button>';
                
            
            if (formContainer) {
                formContainer.appendChild(formRow);
                
                // Add event listener for remove button
                const removeBtn = formRow.querySelector('.remove-form-row');
                if (removeBtn) {
                    removeBtn.addEventListener('click', () => {
                        formRow.remove();
                    });
                }
            }
            
            return formRow;
        }
        
        // Format JSON
        function formatJson() {
            try {
                const content = requestBody?.textContent.trim() || '{}';
                const json = JSON.parse(content);
                const formatted = JSON.stringify(json, null, 2);
                if (requestBody) requestBody.textContent = formatted;
                updateCharCount();
            } catch (e) {
                console.error('Invalid JSON:', e);
                // Show error to user
            }
        }
        
        // Minify JSON
        function minifyJson() {
            try {
                const content = requestBody?.textContent.trim() || '{}';
                const json = JSON.parse(content);
                const minified = JSON.stringify(json);
                if (requestBody) requestBody.textContent = minified;
                updateCharCount();
            } catch (e) {
                console.error('Invalid JSON:', e);
                // Show error to user
            }
        }
        
        // Update character count
        function updateCharCount() {
            let content = '';
            if (state.currentContentType === 'application/json') {
                content = requestBody?.textContent || '';
            } else if (state.currentContentType === 'application/x-www-form-urlencoded') {
                // Handle form data
                content = JSON.stringify(getFormData(), null, 2);
            } else {
                content = rawBody?.value || '';
            }
            
            if (charCount) {
                charCount.textContent = `${content.length} characters`;
            }
            
            // Enable/disable format and minify buttons for JSON
            if (formatJsonBtn && minifyJsonBtn) {
                const isJson = state.currentContentType === 'application/json';
                formatJsonBtn.disabled = !isJson;
                minifyJsonBtn.disabled = !isJson;
            }
        }
        
        // Get form data as object
        function getFormData() {
            const data = {};
            document.querySelectorAll('.form-row').forEach(row => {
                const keyInput = row.querySelector('input:first-child');
                const valueInput = row.querySelector('input:last-child');
                if (keyInput?.value) {
                    data[keyInput.value] = valueInput?.value || '';
                }
            });
            return data;
        }
        
        // Handle tab key in JSON editor
        function handleTabKey(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = this.selectionStart;
                const end = this.selectionEnd;
                
                // Insert tab
                this.value = this.value.substring(0, start) + '    ' + this.value.substring(end);
                
                // Move cursor
                this.selectionStart = this.selectionEnd = start + 4;
            }
        }
        
        // Handle paste in JSON editor
        function handlePaste(e) {
            e.preventDefault();
            const text = (e.clipboardData || window.clipboardData).getData('text/plain');
            
            // Insert text at cursor position
            const start = this.selectionStart;
            const end = this.selectionEnd;
            this.value = this.value.substring(0, start) + text + this.value.substring(end);
            
            // Move cursor to end of pasted text
            this.selectionStart = this.selectionEnd = start + text.length;
            
            // Update character count
            updateCharCount();
        }
        
        // Show URL history dropdown
        function showUrlHistory() {
            if (!urlHistory) return;
            
            if (state.requestHistory.length === 0) {
                urlHistory.innerHTML = '<div class="p-2 text-sm text-gray-400">No history yet</div>';
            } else {
                urlHistory.innerHTML = state.requestHistory
                    .map(function(item) {
                        const isSelected = item.url === urlInput.value ? 'bg-gray-700' : 'hover:bg-gray-700';
                        return '
                            <div class="p-2 text-sm cursor-pointer ' + isSelected + ' flex justify-between items-center" 
                                 data-url="' + item.url + '" 
                                 data-method="' + item.method + '">
                                <span class="font-mono">' + item.method + ' ' + item.url + '</span>
                                <span class="text-xs text-gray-500">' + new Date(item.timestamp).toLocaleString() + '</span>
                            </div>';
                    })
                    .join('');
                
                // Add click handlers for history items
                urlHistory.querySelectorAll('div[data-url]').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const url = item.getAttribute('data-url');
                        const method = item.getAttribute('data-method');
                        
                        if (url) urlInput.value = url;
                        if (method && methodSelect) methodSelect.value = method;
                        
                        // Optionally load the full request details
                        loadRequestFromHistory(url, method);
                        
                        // Hide the dropdown
                        urlHistory.classList.add('hidden');
                    });
                });
            }
            
            // Position and show the dropdown
            if (urlInput && urlHistory) {
                const rect = urlInput.getBoundingClientRect();
                urlHistory.style.width = `${rect.width}px`;
                urlHistory.style.top = `${rect.bottom + window.scrollY}px`;
                urlHistory.style.left = `${rect.left + window.scrollX}px`;
                urlHistory.classList.remove('hidden');
            }
        }
        
        // Load a request from history
        function loadRequestFromHistory(url, method) {
            const request = state.requestHistory.find(
                req => req.url === url && req.method === method
            );
            
            if (request) {
                // Load URL and method
                if (urlInput) urlInput.value = url || '';
                if (methodSelect) methodSelect.value = method || 'GET';
                
                // Load headers
                if (headersContainer) {
                    headersContainer.innerHTML = '';
                    if (request.headers) {
                        Object.entries(request.headers).forEach(([name, value]) => {
                            addHeader(name, value);
                        });
                    }
                }
                
                // Load body if exists
                if (request.body) {
                    if (typeof request.body === 'object') {
                        // Handle JSON body
                        contentTypeSelect.value = 'application/json';
                        handleContentTypeChange();
                        if (requestBody) requestBody.textContent = JSON.stringify(request.body, null, 2);
                    } else if (typeof request.body === 'string') {
                        // Handle raw text body
                        contentTypeSelect.value = 'text/plain';
                        handleContentTypeChange();
                        if (rawBody) rawBody.value = request.body;
                    }
                } else {
                    // Default to JSON
                    contentTypeSelect.value = 'application/json';
                    handleContentTypeChange();
                    if (requestBody) requestBody.textContent = '{}';
                }
                
                // Update character count
                updateCharCount();
            }
        }
        
        // Render request history
        function renderHistory() {
            if (!historyList) return;
            
            if (state.requestHistory.length === 0) {
                historyList.innerHTML = '<div class="text-center py-4 text-gray-500">No history yet</div>';
                return;
            }
            
            historyList.innerHTML = state.requestHistory
                .sort(function(a, b) { 
                    return new Date(b.timestamp) - new Date(a.timestamp); 
                })
                .map(function(item) {
                    return '
                        <div class="p-3 border-b border-gray-700 hover:bg-gray-700/50 cursor-pointer flex justify-between items-center" 
                             data-url="' + item.url + '" 
                             data-method="' + item.method + '">
                            <div>
                                <span class="font-mono px-2 py-1 rounded text-xs ' + getMethodColor(item.method) + ' mr-2">' + item.method + '</span>
                                <span class="text-sm">' + item.url + '</span>
                            </div>
                            <span class="text-xs text-gray-500">' + formatTimeAgo(item.timestamp) + '</span>
                        </div>';
                })
                .join('');
            
            // Add click handlers for history items
            historyList.querySelectorAll('div[data-url]').forEach(item => {
                item.addEventListener('click', (e) => {
                    const url = item.getAttribute('data-url');
                    const method = item.getAttribute('data-method');
                    loadRequestFromHistory(url, method);
                    
                    // Close the history modal
                    const historyModal = document.getElementById('history-modal');
                    if (historyModal) historyModal.classList.add('hidden');
                });
            });
        }
        
        // Get color class for HTTP methods
        function getMethodColor(method) {
            const colors = {
                GET: 'bg-green-900 text-green-300',
                POST: 'bg-blue-900 text-blue-300',
                PUT: 'bg-yellow-900 text-yellow-300',
                DELETE: 'bg-red-900 text-red-300',
                PATCH: 'bg-purple-900 text-purple-300',
                HEAD: 'bg-gray-700 text-gray-300',
                OPTIONS: 'bg-gray-600 text-gray-200'
            };
            return colors[method] || 'bg-gray-800 text-gray-400';
        }
        
        // Format time as "X time ago"
        function formatTimeAgo(timestamp) {
            const seconds = Math.floor((new Date() - new Date(timestamp)) / 1000);
            
            const intervals = {
                year: 31536000,
                month: 2592000,
                week: 604800,
                day: 86400,
                hour: 3600,
                minute: 60,
                second: 1
            };
            
            for (const [unit, secondsInUnit] of Object.entries(intervals)) {
                const interval = Math.floor(seconds / secondsInUnit);
                if (interval >= 1) {
                    return interval === 1 ? `1 ${unit} ago` : `${interval} ${unit}s ago`;
                }
            }
            
            return 'just now';
        }
        
        // Load environment variables
        function loadEnvironment() {
            if (!state.currentEnvironment) return;
            
            const env = state.environments[state.currentEnvironment];
            if (!env) return;
            
            // Set environment select
            const envSelect = document.getElementById('env-select');
            if (envSelect) {
                envSelect.value = state.currentEnvironment;
                
                // Add event listener for environment change
                envSelect.addEventListener('change', (e) => {
                    state.currentEnvironment = e.target.value;
                    localStorage.setItem('currentEnvironment', state.currentEnvironment);
                    loadEnvironment();
                });
            }
            
            // Apply environment variables to URL and headers
            if (env.variables) {
                // Apply to URL
                if (urlInput) {
                    let url = urlInput.value;
                    Object.entries(env.variables).forEach(([key, value]) => {
                        const pattern = new RegExp(`\\${{${key}}}\\b`, 'g');
                        url = url.replace(pattern, value);
                    });
                    urlInput.value = url;
                }
                
                // Apply to headers
                // This is a simplified example - you might want to be more selective
                // about which headers get environment variables applied
                document.querySelectorAll('.header-value').forEach(input => {
                    let value = input.value;
                    Object.entries(env.variables).forEach(([key, val]) => {
                        const pattern = new RegExp(`\\${{${key}}}\\b`, 'g');
                        value = value.replace(pattern, val);
                    });
                    input.value = value;
                });
            }
        }
        
        // Save request to history
        function saveToHistory(request) {
            // Add to history
            state.requestHistory.unshift({
                ...request,
                timestamp: new Date().toISOString()
            });
            
            // Keep only the last 50 requests
            if (state.requestHistory.length > 50) {
                state.requestHistory = state.requestHistory.slice(0, 50);
            }
            
            // Save to localStorage
            localStorage.setItem('requestHistory', JSON.stringify(state.requestHistory));
            
            // Update UI
            renderHistory();
        }

        // --- DOM Element References ---
        const sendRequestBtn = document.getElementById('sendRequest');
        const sendText = document.getElementById('send-text');
        const sendIcon = document.getElementById('send-icon');
        const loadingSpinner = document.getElementById('loading-spinner');
        const statusElement = document.getElementById('status');
        const responseBodyElement = document.getElementById('responseBody');
        const responseHeadersElement = document.getElementById('responseHeaders');
        const addHeaderBtn = document.getElementById('add-header');
        const headersContainer = document.getElementById('headers-container');

        // --- Helper Functions ---
        const createHeaderRow = () => {
            const row = document.createElement('div');
            row.className = 'header-row flex items-center gap-2';
            row.innerHTML = `
                <input type="text" placeholder="Header" class="header-name flex-grow bg-gray-900 border border-gray-700 rounded-md px-3 py-1.5 text-white placeholder-gray-500 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 text-sm">
                <input type="text" placeholder="Value" class="header-value flex-grow bg-gray-900 border border-gray-700 rounded-md px-3 py-1.5 text-white placeholder-gray-500 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 text-sm">
                <button class="remove-header p-1.5 text-gray-500 hover:text-red-400 hover:bg-gray-700 rounded-md transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                    </svg>
                </button>
            `;
            row.querySelector('.remove-header').addEventListener('click', () => row.remove());
            headersContainer.appendChild(row);
        };

        const setupTabSystem = (tabSelector, contentSelector, activeClass) => {
            document.querySelectorAll(tabSelector).forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll(tabSelector).forEach(t => t.classList.remove(activeClass));
                    document.querySelectorAll(contentSelector).forEach(c => c.classList.remove('active'));

                    tab.classList.add(activeClass);
                    const tabId = tab.getAttribute('data-tab');
                    const content = document.getElementById(tabId + '-tab');
                    if (content) content.classList.add('active');
                });
            });
        };

        // --- Event Listeners ---
        
        // Setup tab systems
        setupTabSystem('.request-tab', '.tab-content', 'active');
        setupTabSystem('.response-tab', '.response-tab-content', 'active');

        // Add header button
        addHeaderBtn.addEventListener('click', createHeaderRow);
        
        // Initialize with one header row
        createHeaderRow();

        // Send request button
        sendRequestBtn.addEventListener('click', () => {
            const method = document.getElementById('method').value;
            const urlInput = document.getElementById('url');
            let url = urlInput.value.trim();

            if (!url) {
                vscode.postMessage({ command: 'error', message: 'URL is required' });
                urlInput.focus();
                urlInput.classList.add('ring-2', 'ring-red-500');
                setTimeout(() => urlInput.classList.remove('ring-2', 'ring-red-500'), 2000);
                return;
            }

            if (!/^https?:\/\//.test(url)) {
                url = 'http://' + url;
                urlInput.value = url;
            }

            const headers = {};
            document.querySelectorAll('.header-row').forEach(row => {
                const nameInput = row.querySelector('.header-name');
                const valueInput = row.querySelector('.header-value');
                if (nameInput.value && valueInput.value) {
                    headers[nameInput.value.trim()] = valueInput.value.trim();
                }
            });

            let body = document.getElementById('requestBody').value.trim();

            // Toggle loading state
            sendRequestBtn.disabled = true;
            sendText.classList.add('hidden');
            sendIcon.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            responseBodyElement.textContent = 'Sending request...';
            responseHeadersElement.textContent = '';
            statusElement.textContent = '';
            statusElement.className = 'text-sm font-medium px-3 py-1 rounded-full';

            vscode.postMessage({ command: 'sendRequest', method, url, headers, body });
        });

        // Copy response body
        document.getElementById('copy-response-btn').addEventListener('click', (e) => {
            const textToCopy = responseBodyElement.textContent;
            // Using the clipboard API can be tricky in iFrames, but this is the modern way.
            // A fallback to execCommand might be needed in some environments.
            navigator.clipboard.writeText(textToCopy).then(() => {
                const btn = e.currentTarget;
                const originalText = btn.innerHTML;
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="text-green-400" viewBox="0 0 16 16"><path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022Z"/></svg>`;
                setTimeout(() => { btn.innerHTML = originalText; }, 2000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
            });
        });

        // Handle messages from the extension
        window.addEventListener('message', event => {
            const message = event.data;

            // Restore button state
            sendRequestBtn.disabled = false;
            sendText.classList.remove('hidden');
            sendIcon.classList.remove('hidden');
            loadingSpinner.classList.add('hidden');

            switch (message.command) {
                case 'response':
                    // Status
                    statusElement.textContent = `Status: ${message.status} ${message.statusText || ''}`;
                    if (message.status >= 200 && message.status < 300) {
                        statusElement.classList.add('bg-green-500/20', 'text-green-400');
                    } else if (message.status >= 400) {
                        statusElement.classList.add('bg-red-500/20', 'text-red-400');
                    } else {
                        statusElement.classList.add('bg-yellow-500/20', 'text-yellow-400');
                    }

                    // Headers
                    const headersText = Object.entries(message.headers || {})
                        .map(([key, value]) => `${key}: ${value}`)
                        .join('\n');
                    responseHeadersElement.textContent = headersText || 'No headers received.';

                    // Body
                    let responseBody = message.data;
                    if (typeof responseBody === 'object') {
                        try {
                            responseBody = JSON.stringify(responseBody, null, 2);
                        } catch (e) {
                            responseBody = String(responseBody);
                        }
                    }
                    responseBodyElement.textContent = responseBody || 'No response body.';
                    break;

                case 'error':
                    statusElement.textContent = `Error`;
                    statusElement.classList.add('bg-red-500/20', 'text-red-400');
                    responseBodyElement.textContent = `Error: ${message.message || 'Unknown error'}`;
                    responseHeadersElement.textContent = 'N/A';
                    break;
            }
        });
    </script>

    <!-- History Modal -->
    <div id="history-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-lg w-full max-w-2xl max-h-[80vh] flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-white">Request History</h3>
                <button id="close-history" class="text-gray-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                </button>
            </div>
            <div class="p-4 overflow-y-auto flex-grow">
                <div id="history-list" class="space-y-2">
                    <!-- History items will be added here dynamically -->
                    <div class="text-center py-4 text-gray-500">No history yet</div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-700 flex justify-end space-x-2">
                <button id="clear-history" class="px-4 py-2 text-sm font-medium text-red-400 hover:text-red-300">
                    Clear All
                </button>
                <button id="close-history-btn" class="px-4 py-2 text-sm font-medium bg-gray-700 text-white rounded-md hover:bg-gray-600">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Environment Modal -->
    <div id="env-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-lg w-full max-w-2xl max-h-[80vh] flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-white">Environment Variables</h3>
                <button id="close-env" class="text-gray-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                </button>
            </div>
            <div class="p-4 overflow-y-auto flex-grow">
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium text-gray-300">Select Environment</label>
                        <button id="add-env" class="text-xs text-indigo-400 hover:text-indigo-300">+ New Environment</button>
                    </div>
                    <select id="env-select" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">No Environment</option>
                        <option value="development">Development</option>
                        <option value="production">Production</option>
                    </select>
                </div>
                <div id="env-variables" class="space-y-3">
                    <div class="env-variable flex items-center gap-2">
                        <input type="text" placeholder="Variable" class="flex-1 bg-gray-900 border border-gray-700 rounded-md px-3 py-1.5 text-white placeholder-gray-500">
                        <span class="text-gray-400">=</span>
                        <input type="text" placeholder="Value" class="flex-1 bg-gray-900 border border-gray-700 rounded-md px-3 py-1.5 text-white placeholder-gray-500">
                        <button class="remove-env p-1.5 text-gray-500 hover:text-red-400">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4L4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <button id="add-env-var" class="mt-3 flex items-center gap-1.5 text-sm text-indigo-400 hover:text-indigo-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                    </svg>
                    Add Variable
                </button>
            </div>
            <div class="p-4 border-t border-gray-700 flex justify-end space-x-2">
                <button id="save-env" class="px-4 py-2 text-sm font-medium bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                    Save Changes
                </button>
                <button id="close-env-btn" class="px-4 py-2 text-sm font-medium bg-gray-700 text-white rounded-md hover:bg-gray-600">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        // History Modal Toggle
        const historyModal = document.getElementById('history-modal');
        const historyBtn = document.getElementById('history-btn');
        const closeHistory = document.getElementById('close-history');
        const closeHistoryBtn = document.getElementById('close-history-btn');
        const clearHistoryBtn = document.getElementById('clear-history');
        
        // Environment Modal Toggle
        const envModal = document.getElementById('env-modal');
        const envBtn = document.getElementById('env-btn');
        const closeEnv = document.getElementById('close-env');
        const closeEnvBtn = document.getElementById('close-env-btn');
        const saveEnvBtn = document.getElementById('save-env');
        const addEnvVarBtn = document.getElementById('add-env-var');
        const envVariablesContainer = document.getElementById('env-variables');
        
        // Toggle History Modal
        [historyBtn, closeHistory, closeHistoryBtn].forEach(el => {
            el?.addEventListener('click', () => {
                historyModal.classList.toggle('hidden');
            });
        });
        
        // Toggle Environment Modal
        [envBtn, closeEnv, closeEnvBtn].forEach(el => {
            el?.addEventListener('click', () => {
                envModal.classList.toggle('hidden');
            });
        });
        
        // Clear History
        clearHistoryBtn?.addEventListener('click', () => {
            const historyList = document.getElementById('history-list');
            if (historyList) {
                historyList.innerHTML = '<div class="text-center py-4 text-gray-500">No history yet</div>';
                // Here you would also clear the actual history storage
                vscode.postMessage({ command: 'clearHistory' });
            }
        });
        
        // Add Environment Variable
        const addEnvVariable = () => {
            const envVarHtml = `
                <div class="env-variable flex items-center gap-2">
                    <input type="text" placeholder="Variable" class="flex-1 bg-gray-900 border border-gray-700 rounded-md px-3 py-1.5 text-white placeholder-gray-500">
                    <span class="text-gray-400">=</span>
                    <input type="text" placeholder="Value" class="flex-1 bg-gray-900 border border-gray-700 rounded-md px-3 py-1.5 text-white placeholder-gray-500">
                    <button class="remove-env p-1.5 text-gray-500 hover:text-red-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4L4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                        </svg>
                    </button>
                </div>
            `;
            const temp = document.createElement('div');
            temp.innerHTML = envVarHtml.trim();
            const newEnvVar = temp.firstChild;
            
            // Add remove event listener
            const removeBtn = newEnvVar.querySelector('.remove-env');
            removeBtn.addEventListener('click', () => {
                newEnvVar.remove();
            });
            
            envVariablesContainer.appendChild(newEnvVar);
        };
        
        // Add event listener for adding environment variables
        addEnvVarBtn?.addEventListener('click', addEnvVariable);
        
        // Save environment variables
        saveEnvBtn?.addEventListener('click', () => {
            const envVars = {};
            document.querySelectorAll('.env-variable').forEach(envVar => {
                const inputs = envVar.querySelectorAll('input');
                if (inputs[0].value) {
                    envVars[inputs[0].value] = inputs[1].value;
                }
            });
            
            const envData = {
                name: document.getElementById('env-select').value,
                variables: envVars
            };
            
            // Send to extension
            vscode.postMessage({
                command: 'saveEnvironment',
                data: envData
            });
            
            envModal.classList.add('hidden');
        });
        
        // Initialize with one empty environment variable
        if (envVariablesContainer && envVariablesContainer.children.length === 0) {
            addEnvVariable();
        }
    </script>
</body>
</html>
